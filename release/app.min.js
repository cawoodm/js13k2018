var f={},g,n,q,r,t,u,v,A,B,C=console.log,D,E,F,G,J,K=window.innerWidth||document.documentElement.clientWidth||document.body.offsetWidth,L=window.innerHeight||document.documentElement.clientHeight||document.body.offsetHeight;document.body.style.padding=document.body.style.margin="0px";document.body.style.width=window.innerWidth+"px";document.body.style.height=window.innerHeight+"px";var N=document.createElement("canvas");document.body.appendChild(N);var O=N.getContext("2d");N.width=K;N.height=L;
var Q={};function aa(a,b){var c=new Image;c.src=b;c.onload=this.ia.bind(this);this.get[a]=c;this.aa++}function ba(a){0==this.aa&&a()}Ticker=function(a,b,c){this.state="stop";this.J=0;this.A=1E3/a;this.W=b;this.V=c};Ticker.prototype.start=function(){this.state="go";this.P=this.O=window.performance.now();this.loop()};
Ticker.prototype.loop=function(){if("stop"!=this.state){window.requestAnimationFrame(this.loop.bind(this));this.J++;var a=window.performance.now(),b=a-this.O;this.X=1E3/b;var c=a-this.P||0;2E4<b&&R();this.W(c/this.A);this.P=a;b>this.A&&(this.O=a-b%this.A,this.V())}};Ticker.prototype.stop=function(){this.state="stop"};function ca(a){this.x=a.x||0;this.y=a.y||0;this.b=a.b||D;this.a=a.a||D;this.v=a.v||0;this.H=a.H||0;this.scale=a.scale||1;this.L=a.L||!1;this.ba=Q[a.j||"sprites"];return this}
ca.prototype.g=function(a){a.save();this.S=this.b*this.scale;this.R=this.a*this.scale;this.L&&O.translate(-this.S/2,-this.R/2);a.drawImage(this.ba,this.v,this.H,this.b,this.a,this.x,this.y,this.S,this.R);a.restore()};
function S(a){var b={};b.M=Array.isArray(a)?a:[a];b.D=!1;b.F=!0;b.$=function(a){b.M.includes(a.code)&&(b.m?b.m():b.F&&b.o&&b.o(),b.D=!0,b.F=!1,a.preventDefault())};b.ha=function(a){b.M.includes(a.code)&&(b.D&&b.release&&b.release(),b.D=!1,b.F=!0,a.preventDefault())};b.Z=function(a){b.o(a)};"click"!==a?(window.addEventListener("keydown",b.$.bind(b),!1),window.addEventListener("keyup",b.ha.bind(b),!1)):document.addEventListener("touchstart",b.Z.bind(b),!1);return b}
function T(){var a=a||{};this.entities=a.entities||[];return this}T.prototype.add=function(a){this.entities.push(a);return a};T.prototype.remove=function(a){ents="number"==typeof a.length?a:[a];for(a=0;a<ents.length;a++)for(var b=0;b<this.entities.length;b++)this.entities[b]==ents[a]&&this.entities.splice(b,1)};T.prototype.get=function(a){result=[];this.entities.forEach(function(b){(!a||b.tag===a||Array.isArray(a)&&a.includes(b.tag))&&result.push(b)},this);return result};T.prototype.count=function(a){return this.get(a).length};
function da(){this.f=new Ticker(60,function(a){ea(a)},function(){fa()});f.f.start()}function R(){"gameOver"==g?U():"stop"==f.f.state?(g="play",f.f.start()):(f.f.stop(),f.T&&f.T.ca&&f.T.ca.pause(),g="pause")}function ea(a){"function"==typeof f.ea&&f.ea(a);n.entities.forEach(function(b){"function"===typeof b.update&&b.update(a)},this);"function"==typeof f.da&&f.da()}
function fa(){O.clearRect(0,0,K/E.x,L/E.y);O.save();"function"==typeof ha&&(O.save(),ha(),O.restore());q&&O.translate(-q.x,-q.y);n.entities.forEach(function(a){var b;if((b="function"===typeof a.g)&&(b=!a.ka)&&!(b=!q)){var c=q;if(a.U||"undefined"===typeof a.b||"undefined"===typeof a.a)b=!0;else{b=c.x;var h=c.x+c.b,m=c.y;c=c.y+c.a;var k=a.x,e=a.x+a.b,d=a.y,l=a.y+a.a;b=(k>=b&&h>=k||e>=b&&h>=e||b>=k&&e>=b||h>=k&&e>=h)&&(d>=m&&c>=d||l>=m&&c>=l||m>=d&&l>=m||c>=d&&l>=c)}}b&&(O.save(),a.U&&q&&O.translate(q.x,
q.y),a.g(O),O.restore())},this);"function"==typeof ia&&(O.save(),ja(),O.restore());O.restore()}function ka(){C("No game defined in g.init(). Start coding!")}function U(){C("No game defined in g.restart(). Start coding!")}window.addEventListener("load",function(){var a=ka();ba(a)});Camera=function(a){this.x=a.x||0;this.y=a.y||0;this.b=a.b||500;this.a=a.a||500;this.tag=a.tag||"camera";this.c={x:0,y:0,b:a.c||300,a:a.c||300}};
Camera.prototype.update=function(){r.x<this.c.x&&(this.c.x=r.x);r.x+r.b>this.c.x+this.c.b&&(this.c.x=r.x+r.b-this.c.b);r.y<this.c.y&&(this.c.y=r.y);r.y+r.a>this.c.y+this.c.a&&(this.c.y=r.y+r.a-this.c.a);var a=this.c.x+this.c.b/2,b=this.c.y+this.c.a/2,c=this.x+this.b/2,h=this.y+this.a/2;if(a!=c||b!=h)this.x+=a-c,this.y+=b-h};
Camera.prototype.g=function(){Camera.debug&&(O.strokeStyle="#00F",O.strokeRect(this.c.x,this.c.y,this.c.b,this.c.a),O.fillStyle="#F00",O.fillRect(this.x+this.b/2-2,this.y+this.a/2-5,4,10),O.fillStyle="#00F",O.strokeRect(this.c.x+this.c.b/2-5,this.c.y+this.c.a/2-5,10,10))};function V(){var a=a||{};this.h=a.h||[]}V.prototype.update=function(){if("play"==g)for(var a=0;a<this.h.length;a++){var b=W(this.h[a].fa,this.h[a].ga);0<b.length&&this.h[a].Y(b[0],b[1])}};V.prototype.g=function(){V.debug&&this.update(1)};
V.prototype.check=function(a,b,c){this.h.push({fa:a,ga:b,Y:c})};
function W(a,b,c){a="string"==typeof a?n.get(a):[a];b=n.get(b);for(var h=0;h<a.length;h++)for(var m=0;m<b.length;m++){var k;if(k=a[h]!=b[m]){k=a[h];var e=b[m],d=k.speed?k.speed.x:0,l=k.speed?k.speed.y:0,p=c||k.N||0,w=c||e.N||0,z=k.x+d+p;d=k.x+d+k.b-1-p;var H=k.y+l+p;l=k.y+l+k.a-1-p;p=e.x+w;var M=e.x+e.b-1-w,I=e.y+w;w=e.y+e.a-1-w;var P=I>=H&&l>=I||w>=H&&l>=w||H>=I&&w>=H||l>=I&&w>=l;P=(p>=z&&d>=p||M>=z&&d>=M||z>=p&&M>=z||d>=p&&M>=d)&&P;V.debug&&k.tag==V.debug[0]&&e.tag==V.debug[1]&&(O.lineWidth=P?5:
1,k.tag==V.debug[0]&&(O.strokeStyle="#0FF",O.strokeRect(z,H,d-z,l-H)),e.tag==V.debug[1]&&(O.strokeStyle="#F00",O.strokeRect(p,I,M-p,w-I)));k=P}if(k)return[a[h],b[m]]}return[]}function X(){this.U=!0;this.i=!1;this.level=1;for(var a=this.C=n.get("house"),b=a.length-1;0<b;b--){var c=Math.floor(Math.random()*(b+1)),h=a[b];a[b]=a[c];a[c]=h}this.w=[];return this}
X.prototype.update=function(){if(0==f.f.J%30){if(this.w.length<2*this.level)a:for(i=0;i<this.C.length;i++){var a=this.C[i];if(!this.w.includes(a)&&a.s(t)<5*this.level){this.w.push(la(a));break a}}this.i=!this.i}};X.prototype.g=function(a){a.fillStyle="white";a.fillText(Math.round(f.f.X/10)+"0",10,10)};function ma(){u.w.forEach(function(a){1>=Math.round(a.s(r))&&(a.B="blue",a.u=!0,a.I=f.f.J)});1>=Math.round(r.s(t))&&C("home")}
function Y(a){this.x=a.x;this.y=a.y;this.b=a.b||D;this.a=a.a||D;this.tag="house";this.u=!1;this.B="";this.I=0;return this}Y.prototype.update=function(){};Y.prototype.g=function(a){this.u&&u.i&&(a.strokeStyle="#fff",0<this.I&&(a.strokeStyle="#00f"),a.lineWidth="3",a.strokeRect(this.x,this.y,this.b,this.a))};function la(a){a.B="white";a.u=!0;a.I=0;return a}Y.prototype.s=function(a){return Math.sqrt(Math.pow(a.x-this.x,2)+Math.pow(a.y-this.y,2))/D};function na(){return this}
function ja(){O.translate(-F/E.x,100);O.fillStyle="rgba(0,0,0,0.8)";O.fillRect(q.x+2,q.y+2,40,100);n.get(["player","pizzeria","house"]).forEach(function(a){var b=a.x/D,c=a.y/D,h=1;"player"==a.tag?(O.fillStyle="red",h=u.i?3:1):"pizzeria"==a.tag?(O.fillStyle="magenta",h=u.i?3:1):a.u&&u.i?(O.fillStyle=a.B,h=3):O.fillStyle="rgba(100,100,100,0.75)";O.fillRect(q.x+b-h/2,q.y+c-h/2,h,h)})}
function Z(){var a={x:28*D,y:37*D,l:2};this.x=a.x||0;this.y=a.y||0;this.b=a.b||D;this.a=a.a||D;this.j=new ca({j:"spritemap",b:this.b,a:this.a,v:128,H:96,scale:1});this.N=0;this.tag="player";this.K={x:0,y:0};this.speed={x:0,y:0};this.l=a.l||5;this.frame=0;v.check(this,["house","block"],function(){r.stop()});return this}
Z.prototype.update=function(a){"play"==g&&(this.G&&this.move(this.G),this.speed.x+=this.K.x*a,this.speed.y+=this.K.y*a,this.x+=this.speed.x,this.y+=this.speed.y,0<this.speed.x?this.frame=0:0>this.speed.x?this.frame=1:0>this.speed.y?this.frame=2:0<this.speed.y&&(this.frame=3))};Z.prototype.g=function(a){this.j.x=this.x;this.j.y=this.y;this.j.v=4*D+this.frame*D;this.j.g(a)};
Z.prototype.move=function(a){this.G=null;if(a.x*this.l==this.speed.x&&a.y*this.l==this.speed.y)return this.stop();var b={tag:"ghost",x:this.x,y:this.y,b:this.b,a:this.a,speed:{x:a.x*this.l,y:a.y*this.l}},c=0<W(b,["house","block"],0).length,h=0<W(this,["house","block"],1).length,m=0==this.speed.x+this.speed.y,k=0!==a.y&&0==this.x%D||0!==a.x&&0==this.y%D;h&&c||(m&&!c?this.speed=b.speed:c||!k?this.G=a:this.speed=b.speed)};Z.prototype.stop=function(){this.speed={x:0,y:0};ma()};
Z.prototype.s=function(a){return Math.sqrt(Math.pow(a.x-this.x,2)+Math.pow(a.y-this.y,2))/D};ka=function(){D=32;G=10;J=document.createElement("canvas");A=J.getContext("2d");F=100;E={x:2,y:2};N.width=F+G*D*E.x;N.height=G*D*E.y;N.style.position="absolute";N.style.left=.5*G*D*E.y+"px";O.translate(F,0);O.scale(E.x,E.y);O.ja=!1;aa("tilemap","./tilemap.png");aa("spritemap","./spritemap.png");return function(){U(!1)}};
U=function(a){f.f&&(f.f.stop(),g="halt");n=new T;var b=document.createElement("canvas").getContext("2d"),c=Q.tilemap;b.drawImage(c,0,0);b=b.getImageData(0,0,c.width,c.height).data;var h=[];B=[];for(var m=0;m<c.height;m++){var k=[];k.length=c.width;for(var e=0;e<c.width;e++){var d=4*(m*c.width+e);d=[b[d],b[d+1],b[d+2],b[d+3]];if(0==m&&e<c.width)h.push(d);else for(var l=0;l<h.length;l++)if(d[0]===h[l][0]&&d[1]===h[l][1]&&d[2]===h[l][2]){k[e]=l;break}}0<m&&B.push(k)}c=D;b=B[0].length;h=B.length;J.width=
b*c;J.height=h*c;m=A;m.fillStyle="#DDD";m.fillRect(0,0,J.width,J.height);k=Q.spritemap;for(e=0;e<h;e++)for(d=0;d<b;d++)2<B[e][d]&&m.drawImage(k,2*c,0,c,c,d*c,e*c,c,c);for(e=0;e<h;e++)for(d=0;d<b;d++){m.globalAlpha=1;l=0;var p=1,w=0,z=Math.random();0==B[e][d]&&(m.globalAlpha=.9+.1*z);1==B[e][d]&&(m.globalAlpha=.5+.4*z);0==B[e][d]&&.25>z&&(l=1);1==B[e][d]&&.25>z&&(l=1);if(3==B[e][d]){if(.25>z)l=1;else if(.5>z)l=2;else if(.75>z)l=3;else{n.add({tag:"block",x:d*D,y:e*D,b:D,a:D});B[e][d]=-1;continue}n.add(new Y({x:d*
D,y:e*D}))}2==B[e][d]?m.drawImage(k,2*c,l*c*p,c,p*c,d*c,e*c-w*c,c,c*p):(15==B[e][d]&&(t=n.add({tag:"pizzeria",x:d*D,y:e*D,b:D,a:D}),p=2,w=1),16==B[e][d]&&(n.add({tag:"block",x:d*D,y:e*D,b:D,a:D}),p=2,w=1),17==B[e][d]?n.add({tag:"block",x:d*D,y:e*D,b:D,a:D}):m.drawImage(k,B[e][d]*c,l*c*p,c,p*c,d*c,e*c-w*c,c,c*p))}a?(g="title",n.add(new GameTitle)):(q=n.add(new Camera({x:24*D,b:G*D,a:G*D,c:200})),v=n.add(new V),u=n.add(new X),n.add(new na),r=n.add(new Z),g="play");da()};
function ha(){O.drawImage(J,q.x,q.y,320,320,0,0,320,320)}function ia(){ja()}var oa=S(["KeyA","ArrowLeft"]),pa=S(["KeyD","ArrowRight"]),qa=S(["KeyW","ArrowUp"]),ra=S(["KeyS","ArrowDown"]),sa=S("Space"),ta=S("click");S("clickCtrl");oa.m=function(){if("pause"==g)return R();"play"==g&&r.move({x:-1,y:0})};pa.m=function(){if("pause"==g)return R();"play"==g&&r.move({x:1,y:0})};qa.m=function(){if("pause"==g)return R();"play"==g&&r.move({x:0,y:-1})};
ra.m=function(){if("pause"==g)return R();"play"==g&&r.move({x:0,y:1})};sa.o=function(a){if("message"!=g){if("play"!=g)return U();a&&a.touches||r.stop()}};ta.o=sa.o;